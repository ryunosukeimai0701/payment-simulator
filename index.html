<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>京都信販シミュレーション（営業マン用）</title>
    <style>
        /* ... (既存のCSS) ... */
    </style>
</head>
<body>
    <div class="header-banner">
        <h1>京都信販シミュレーション（営業マン用）</h1>
    </div>

    <p>
        当社のクレジット契約におけるお支払い額やお支払い回数のシミュレーションを行うことができます。
        以下のシミュレーションは実質年率を20%とした場合の計算になります。
    </p>

    <div class="info-box">
        <h3>ご契約条件</h3>
        <div class="contract-conditions">
            <div class="condition-item">
                <p>お申込者様ご年齢</p>
                <p>申込時20歳以上完済時76歳未満</p>
            </div>
            <div class="condition-item">
                <p>お申込可能商品金額</p>
                <p>5万円以上200万円以下(消費税込)</p>
            </div>
            <div class="condition-item">
                <p>お支払い回数</p>
                <p>3, 6, 10, 12, 15, 18, 20, 24, 30, 36, 42, 48, 54, 60回</p>
                <p class="note">※ 通常回のお支払い額が3千円以上になる場合のみ</p>
            </div>
            <div class="condition-item">
                <p>分割手数料率</p>
                <p>原則 実質年率20%（商品により異なる場合があります）</p>
            </div>
        </div>
    </div>

    <h2>商品金額とお支払回数から月々のお支払い額を計算する</h2>

    <div class="calculator">
        <h3>入力項目</h3>

        <div class="input-field">
            <label for="interview-date">記入面談日</label>
            <div>
                <input type="date" id="interview-date">
            </div>
        </div>

        <div class="input-field">
            <label for="payment-date">初回支払日</label>
            <div id="payment-date"></div>
        </div>

        <div class="input-field">
            <label for="emp-price">商品金額</label>
            <div>
                <input type="number" id="emp-price" value="500000" min="50000" max="10000000">
                <span>円</span>
            </div>
        </div>

        <div class="input-field">
            <label for="emp-dpay">頭金</label>
            <div>
                <input type="number" id="emp-dpay" value="0" min="0">
                <span>円</span>
            </div>
        </div>

        <div class="input-field">
            <label for="emp-bmonth1">ボーナス月1</label>
            <select id="emp-bmonth1">
                <option value="0" selected>利用しない</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
            </select>
        </div>

        <div class="input-field">
            <label for="emp-bmonth2">ボーナス月2</label>
            <select id="emp-bmonth2">
                <option value="0" selected>利用しない</option>
                <option value="12">12月</option>
                <option value="1">1月</option>
            </select>
        </div>

        <div class="input-field">
            <label for="emp-baddpay">ボーナス月加算額</label>
            <div>
                <input type="number" id="emp-baddpay" value="0" min="0">
                <span>円</span>
            </div>
        </div>

        <div class="input-field">
            <label for="emp-frequency">お支払回数</label>
            <select id="emp-frequency">
                <option value="3">3回</option>
                <option value="6">6回</option>
                <option value="10">10回</option>
                <option value="12" selected>12回</option>
                <option value="15">15回</option>
                <option value="18">18回</option>
                <option value="20">20回</option>
                <option value="24">24回</option>
                <option value="30">30回</option>
                <option value="36">36回</option>
                <option value="42">42回</option>
                <option value="48">48回</option>
                <option value="54">54回</option>
                <option value="60">60回</option>
            </select>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" id="calculate-emp">計算</button>
            <button class="btn btn-secondary" id="reset-emp">計算結果削除</button>
        </div>

        <div class="note">
            <ul>
                <li>※ 当社で選択出来るお支払い回数のみが選択可能です。</li>
                <li>※ ボーナス払いの場合、本日お申込頂いた場合を基準に計算しております。</li>
                <li>※ 全ての項目に入力が必要です。頭金・ボーナス払いを利用しないときは0円とご入力下さい。</li>
            </ul>
        </div>
    </div>

    <div id="emp-results" class="results hidden">
        </div>

    <div class="footer">
        <p>
            ※このシミュレーターは、オリジナルの計算機能に「手数料分の明示」などの機能を追加した営業部用のツールです。
        </p>
        <p>
            実際のお支払いについては、京都信販株式会社の最新のご案内をご確認ください。
        </p>
    </div>

    <script>
        // 手数料率テーブル
        const frequencyRateTable = [
            1.67, 2.51, 3.35, 4.2, 5.06, 5.91, 6.78, 7.64, 8.52, 9.39, 10.28, 11.16,
            12.05, 12.95, 13.85, 14.75, 15.66, 16.57, 17.49, 18.41, 19.34, 20.27,
            21.21, 22.15, 23.1, 24.04, 25, 25.96, 26.92, 27.89, 28.86, 29.84, 30.82,
            31.8, 32.79, 33.79, 34.79, 35.79, 36.8, 37.81, 38.83, 39.85, 40.87, 41.9,
            42.94, 43.98, 45.02, 46.07, 47.12, 48.17, 49.23, 50.3, 51.37, 52.44,
            53.52, 54.6, 55.68, 56.77, 57.87, 58.96
        ];

        // 選択可能な回数
        const validFrequencies = [3, 6, 10, 12, 15, 18, 20, 24, 30, 36, 42, 48, 54, 60];

        // 支払回数の適合チェック
        function frequencyCheck(frequency) {
            return validFrequencies.includes(Number(frequency));
        }

        // 手数料率取得
        function getRate(frequency) {
            return frequencyRateTable[frequency - 1];
        }

        // 現在の決済開始月を計算
        function calcFDate() {
            const date = new Date();
            const today = date.getDate();
            if (today <= 14) {
                return (date.getMonth() + 1);
            } else {
                return ((date.getMonth() + 2) > 12 ? (date.getMonth() + 2) - 12 : (date.getMonth() + 2));
            }
        }

        // ボーナス支払い回数を計算
        function calcBCount(frequency, bmonth1, bmonth2) {
            let count = 0;
            for (let i = 0; i < frequency; i++) {
                let b = (calcFDate() + i) % 12;
                b = b === 0 ? 12 : b;
                if (b === Number(bmonth1) || b === Number(bmonth2)) {
                    count++;
                }
            }
            return count;
        }

        // 数値のフォーマット
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // 初回支払日を計算する関数
        function calculateFirstPaymentDate(interviewDate) {
            const date = new Date(interviewDate);
            const day = date.getDate();
            const month = date.getMonth();
            const year = date.getFullYear();

            if (day <= 14) {
                return new Date(year, month, 27);
            } else {
                const nextMonth = month === 11 ? 0 : month + 1;
                const nextYear = month === 11 ? year + 1 : year;
                return new Date(nextYear, nextMonth, 27);
            }
        }

        // 記入面談日のイベントリスナー
        const interviewDateInput = document.getElementById('interview-date');
        const paymentDateDiv = document.getElementById('payment-date');

        interviewDateInput.addEventListener('change', function() {
            const selectedDate = this.value;
            if (selectedDate) {
                const paymentDate = calculateFirstPaymentDate(selectedDate);
                const formattedDate = `<span class="math-inline">\{paymentDate\.getFullYear\(\)\}年</span>{paymentDate.getMonth() + 1}月${paymentDate.getDate()}日`;
                paymentDateDiv.textContent = formattedDate;
            } else {
                paymentDateDiv.textContent = '';
            }
        });

        // EMP（商品金額とお支払回数から）の計算
        document.getElementById('calculate-emp').addEventListener('click', calculateEMP);
        document.getElementById('reset-emp').addEventListener('click', resetEMP);

        function calculateEMP() {
            // 入力値の取得
            const price = Number(document.getElementById('emp-price').value);
            const dpay = Number(document.getElementById('emp-dpay').value);
            const frequency = Number(document.getElementById('emp-frequency').value);
            const bmonth1 = Number(document.getElementById('emp-bmonth1').value);
            const bmonth2 = Number(document.getElementById('emp-bmonth2').value);
            const baddpay = Number(document.getElementById('emp-baddpay').value);

            // 入力チェック
            if (price < 50000 || price > 10000000) {
                alert('商品金額は5万円以上1,000万円以下で入力してください。');
                return;
            }

            // 残金(立替額)
            const advance = price - dpay;

            // 手数料率
            const interestRate = getRate(frequency);

            // 手数料額（小数点以下を考慮）
            const interestAmount = Math.round(advance * interestRate * 100) / 100;

            // 分割支払金合計
            const payment = advance + interestAmount;

            // 支払総額 = 分割支払金合計 + 頭金
            const total = payment + dpay;

            let first, rest, bonus = 0;
            let bcount = 0;

            // 初回と通常回の分割支払金の算出
            if (bmonth1 === 0 && bmonth2 === 0) {
                rest = Math.floor(payment / frequency);
                first = payment - rest * (frequency - 1);
            } else if (baddpay === 0) {
                rest = Math.floor(payment / frequency);
                first = payment - rest * (frequency - 1);
            } else {
                // ボーナス回の回数
                bcount = calcBCount(frequency, bmonth1, bmonth2);
                const paymentWithoutBonus = payment - bcount * baddpay;
                rest = Math.floor(paymentWithoutBonus / (frequency - bcount));
                bonus = rest + baddpay;

                // 初回がボーナス月であるかどうか
                const isFirstBonus = calcFDate() === bmonth1 || calcFDate() === bmonth2;
                if (isFirstBonus) {
                    first = bonus;
                    // 初回ボーナスがある場合、通常回数を調整
                    rest = Math.floor((payment - bonus - (bcount - 1) * bonus) / (frequency - bcount));
                    // 残りの端数を初回に加算
                    first += (payment - (rest * (frequency - bcount)) - (bcount - 1) * bonus - first);
                } else {
                    first = rest;
                    // 残りの端数を初回に加算
                    first += (payment - (rest * (frequency - bcount)) - bcount * bonus - first);
                }
            } else {
                rest = Math.floor(payment / frequency);
                first = payment - rest * (frequency - 1);
                // 残りの端数を初回に加算
                first += (payment - rest * frequency);
            }

            // 計算結果の表示
            displayEMPResults({
                price,
                dpay,
                frequency,
                advance,
                interestRate,
                interestAmount,
                payment,
                total,
                first,
                rest,
                bonus,
                bcount,
                bmonth1,
                bmonth2,
                baddpay
            });
        }

        function displayEMPResults(results) {
            const resultsDiv = document.getElementById('emp-results');
            resultsDiv.classList.remove('hidden');

            // 初回がボーナス月か
            const isFirstBonus = calcFDate() === results.bmonth1 || calcFDate() === results.bmonth2;

            // ボーナス払いがあるか
            const isBonus = results.bmonth1 !== 0 || results.bmonth2 !== 0;

            let html = `<h3>計算結果</h3>`;

            html += `
                <div class="results-summary">
                    <div>
                        <p class="font-semibold">商品価格</p>
                        <p class="text-lg"><span class="math-inline">\{formatNumber\(results\.price\)\}円</p\>
</div\>
<div\>
<p class\="font\-semibold"\>頭金</p\>
<p class\="text\-lg"\></span>{formatNumber(results.dpay)}円</p>
                    </div>
                    <div>
                        <p class="font-semibold">分割対象金額</p>
                        <p class="text-lg"><span class="math-inline">\{formatNumber\(results\.advance\)\}円</p\>
</div\>
<div\>
<p class\="font\-semibold"\>支払回数</p\>
<p class\="text\-lg"\></span>{results.frequency}回</p>
                    </div>
                    <div>
                        <p class="font-semibold" style="color: #ca0028;">手数料（金利）</p>
                        <p class="text-lg"><span class="math-inline">\{formatNumber\(results\.interestAmount\)\}円（</span>{results.interestRate}%）</p>
                    </div>
                </div>

                <div class="results-detail">
                    <div class="detail-header">
                        <p class="font-bold">お支払い内訳</p>
                        <p class="text-sm">※金額単位：円</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>項目</th>
                                <th style="text-align: right;">金額</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="math-inline">\{isFirstBonus ? "第1回目お支払い額（ボーナス月）" \: "第1回目お支払い額"\}</td\>
<td class\="amount"\></span>{formatNumber(Math.round(results.first))}
