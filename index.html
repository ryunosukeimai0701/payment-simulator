<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お支払いシミュレーション（営業部用）</title>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
            line-height: 1.7;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 24px;
        }
        h2 {
            font-size: 20px;
            font-weight: bold;
            padding: 8px 0;
            margin-top: 32px;
            margin-bottom: 16px;
            border-top: 2px solid #ca0028;
            border-bottom: 1px solid #e5e5e5;
        }
        .info-box {
            background-color: #f9f9f9;
            padding: 16px;
            margin-bottom: 24px;
            border-radius: 4px;
        }
        .contract-conditions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        @media (max-width: 768px) {
            .contract-conditions {
                grid-template-columns: 1fr;
            }
        }
        .condition-item p:first-child {
            font-weight: 600;
        }
        .calculator {
            background-color: white;
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        .input-field {
            margin-bottom: 12px;
        }
        .input-field label {
            display: block;
            margin-bottom: 4px;
        }
        .input-field input, .input-field select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
        }
        .button-group {
            margin-top: 16px;
            display: flex;
            gap: 8px;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background-color: #ca0028;
            color: white;
        }
        .btn-secondary {
            background-color: #e0e0e0;
        }
        .note {
            font-size: 14px;
            color: #666;
        }
        .note ul {
            padding-left: 20px;
        }
        .results {
            background-color: white;
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .warning {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-bottom: 16px;
        }
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .results-detail {
            background-color: #ffeeee;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 24px;
        }
        .detail-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
        }
        th {
            background-color: #f0f0f0;
        }
        td.amount {
            text-align: right;
            font-weight: 600;
        }
        .total-amounts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        @media (max-width: 768px) {
            .total-amounts {
                grid-template-columns: 1fr;
            }
        }
        .total-item p:first-child {
            font-weight: 600;
        }
        .total-item p:last-child {
            font-size: 20px;
            font-weight: bold;
        }
        .progress-container {
            margin-bottom: 16px;
        }
        .progress-bar {
            width: 100%;
            height: 24px;
            background-color: #e0e0e0;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .progress-segment {
            height: 100%;
            float: left;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
        }
        .principal {
            background-color: #4b7bec;
        }
        .interest {
            background-color: #e74c3c;
        }
        .downpayment {
            background-color: #2ecc71;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .color-box {
            width: 12px;
            height: 12px;
            margin-right: 4px;
        }
        .footer {
            margin-top: 24px;
            padding: 16px;
            background-color: #f9f9f9;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
        }
        /* 非表示用クラス */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>お支払いシミュレーション（営業部用）</h1>
    
    <p>
        当社のクレジット契約におけるお支払い額やお支払い回数のシミュレーションを行うことができます。
        以下のシミュレーションは実質年率を20%とした場合の計算になります。
    </p>
    
    <div class="info-box">
        <h3>ご契約条件</h3>
        <div class="contract-conditions">
            <div class="condition-item">
                <p>お申込者様ご年齢</p>
                <p>申込時20歳以上完済時76歳未満</p>
            </div>
            <div class="condition-item">
                <p>お申込可能商品金額</p>
                <p>5万円以上150万円以下(消費税込)</p>
            </div>
            <div class="condition-item">
                <p>お支払い回数</p>
                <p>3, 6, 10, 12, 15, 18, 20, 24, 30, 36, 42, 48, 54, 60回</p>
                <p class="note">※ 通常回のお支払い額が3千円以上になる場合のみ</p>
            </div>
            <div class="condition-item">
                <p>分割手数料率</p>
                <p>原則 実質年率20%（商品により異なる場合があります）</p>
            </div>
        </div>
    </div>

    <h2>商品金額とお支払回数から月々のお支払い額を計算する</h2>
    
    <div class="calculator">
        <h3>入力項目</h3>
        
        <div class="input-field">
            <label for="emp-price">商品金額</label>
            <div>
                <input type="number" id="emp-price" value="500000" min="50000" max="1500000">
                <span>円</span>
            </div>
        </div>
        
        <div class="input-field">
            <label for="emp-dpay">頭金</label>
            <div>
                <input type="number" id="emp-dpay" value="0" min="0">
                <span>円</span>
            </div>
        </div>
        
        <div class="input-field">
            <label for="emp-bmonth1">ボーナス月1</label>
            <select id="emp-bmonth1">
                <option value="0" selected>利用しない</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
            </select>
        </div>
        
        <div class="input-field">
            <label for="emp-bmonth2">ボーナス月2</label>
            <select id="emp-bmonth2">
                <option value="0" selected>利用しない</option>
                <option value="12">12月</option>
                <option value="1">1月</option>
            </select>
        </div>
        
        <div class="input-field">
            <label for="emp-baddpay">ボーナス月加算額</label>
            <div>
                <input type="number" id="emp-baddpay" value="0" min="0">
                <span>円</span>
            </div>
        </div>
        
        <div class="input-field">
            <label for="emp-frequency">お支払回数</label>
            <div>
                <input type="number" id="emp-frequency" value="12" min="1" max="60">
                <span>回</span>
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn btn-primary" id="calculate-emp">計算</button>
            <button class="btn btn-secondary" id="reset-emp">計算結果削除</button>
        </div>
        
        <div class="note">
            <ul>
                <li>※ 当社で選択出来るお支払い回数以外の回数をご入力された場合は、参考情報としてご利用下さい。</li>
                <li>※ お支払回数61回以上は計算出来ません。</li>
                <li>※ ボーナス払いの場合、本日お申込頂いた場合を基準に計算しております。</li>
                <li>※ 全ての項目に入力が必要です。頭金・ボーナス払いを利用しないときは0円とご入力下さい。</li>
            </ul>
        </div>
    </div>
    
    <div id="emp-results" class="results hidden">
        <!-- 計算結果がここに表示されます -->
    </div>

    <h2>商品金額と月々のご希望お支払い額からお支払い回数を計算する</h2>
    
    <div class="calculator">
        <h3>入力項目</h3>
        
        <div class="input-field">
            <label for="mpf-price">商品金額</label>
            <div>
                <input type="number" id="mpf-price" value="500000" min="50000" max="1500000">
                <span>円</span>
            </div>
        </div>
        
        <div class="input-field">
            <label for="mpf-dpay">頭金</label>
            <div>
                <input type="number" id="mpf-dpay" value="0" min="0">
                <span>円</span>
            </div>
        </div>
        
        <div class="input-field">
            <label for="mpf-expect">ご希望される月々のお支払い額（通常回）</label>
            <div>
                <input type="number" id="mpf-expect" value="15000" min="3000">
                <span>円/月</span>
            </div>
        </div>
        
        <div class="input-field">
            <label for="mpf-bmonth1">ボーナス月1</label>
            <select id="mpf-bmonth1">
                <option value="0" selected>利用しない</option>
                <option value="6">6月</option>
                <option value="7">7月</option>
                <option value="8">8月</option>
            </select>
        </div>
        
        <div class="input-field">
            <label for="mpf-bmonth2">ボーナス月2</label>
            <select id="mpf-bmonth2">
                <option value="0" selected>利用しない</option>
                <option value="12">12月</option>
                <option value="1">1月</option>
            </select>
        </div>
        
        <div class="input-field">
            <label for="mpf-baddpay">ボーナス月加算額</label>
            <div>
                <input type="number" id="mpf-baddpay" value="0" min="0">
                <span>円</span>
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn btn-primary" id="calculate-mpf">計算</button>
            <button class="btn btn-secondary" id="reset-mpf">計算結果削除</button>
        </div>
        
        <div class="note">
            <ul>
                <li>※ 全ての項目に入力が必要です。頭金・ボーナス払いを利用しないときは0円とご入力下さい。</li>
            </ul>
        </div>
    </div>
    
    <div id="mpf-results" class="results hidden">
        <!-- 計算結果がここに表示されます -->
    </div>

    <div class="footer">
        <p>
            ※このシミュレーターは、オリジナルの計算機能に「手数料分の明示」と「グラフ表示」などの機能を追加した営業部用のツールです。
        </p>
        <p>
            実際のお支払いについては、京都信販株式会社の最新のご案内をご確認ください。
        </p>
    </div>

    <script>
        // 手数料率テーブル
        const frequencyRateTable = [
            1.67, 2.51, 3.35, 4.2, 5.06, 5.91, 6.78, 7.64, 8.52, 9.39, 10.28, 11.16,
            12.05, 12.95, 13.85, 14.75, 15.66, 16.57, 17.49, 18.41, 19.34, 20.27,
            21.21, 22.15, 23.1, 24.04, 25, 25.96, 26.92, 27.89, 28.86, 29.84, 30.82,
            31.8, 32.79, 33.79, 34.79, 35.79, 36.8, 37.81, 38.83, 39.85, 40.87, 41.9,
            42.94, 43.98, 45.02, 46.07, 47.12, 48.17, 49.23, 50.3, 51.37, 52.44,
            53.52, 54.6, 55.68, 56.77, 57.87, 58.96
        ];

        // 選択可能な回数
        const validFrequencies = [3, 6, 10, 12, 15, 18, 20, 24, 30, 36, 42, 48, 54, 60];

        // 支払回数の適合チェック
        function frequencyCheck(frequency) {
            return validFrequencies.includes(Number(frequency));
        }

        // 手数料率取得
        function getRate(frequency) {
            return frequencyRateTable[frequency];
        }

        // 現在の決済開始月を計算
        function calcFDate() {
            const date = new Date();
            const today = date.getDate();
            if (today <= 14) {
                return (date.getMonth() + 1);
            } else {
                return ((date.getMonth() + 2) > 12 ? (date.getMonth() + 2) - 12 : (date.getMonth() + 2));
            }
        }

        // ボーナス支払い回数を計算
        function calcBCount(frequency, bmonth1, bmonth2) {
            let count = 0;
            for (let i = 0; i < frequency; i++) {
                let b = (calcFDate() + i) % 12;
                b = b === 0 ? 12 : b;
                if (b === Number(bmonth1) || b === Number(bmonth2)) {
                    count++;
                }
            }
            return count;
        }

        // 数値のフォーマット
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // EMP（商品金額とお支払回数から）の計算
        document.getElementById('calculate-emp').addEventListener('click', calculateEMP);
        document.getElementById('reset-emp').addEventListener('click', resetEMP);

        function calculateEMP() {
            // 入力値の取得
            const price = Number(document.getElementById('emp-price').value);
            const dpay = Number(document.getElementById('emp-dpay').value);
            let frequency = Number(document.getElementById('emp-frequency').value);
            const bmonth1 = Number(document.getElementById('emp-bmonth1').value);
            const bmonth2 = Number(document.getElementById('emp-bmonth2').value);
            const baddpay = Number(document.getElementById('emp-baddpay').value);

            // 支払回数を60回までに制限
            if (frequency > 60) {
                frequency = 60;
                document.getElementById('emp-frequency').value = 60;
            }

            // 支払回数チェック
            const isValidFrequency = frequencyCheck(frequency);

            // 残金(立替額)
            const advance = price - dpay;

            // 手数料率
            const interestRate = getRate(frequency - 1);

            // 手数料額
            const interestAmount = Math.floor(advance * interestRate * 100 / 10000);

            // 分割支払金合計
            const payment = advance + interestAmount;

            // 支払総額 = 分割支払金合計 + 頭金
            const total = payment + dpay;

            let first, rest, bonus = 0;
            let bcount = 0;

            // 初回と通常回の分割支払金の算出
            if (bmonth1 === 0 && bmonth2 === 0) {
                rest = Math.floor(payment / frequency / 100) * 100;
                first = payment - rest * (frequency - 1);
            } else if (baddpay === 0) {
                rest = Math.floor(payment / frequency / 100) * 100;
                first = payment - rest * (frequency - 1);
            } else {
                // ボーナス回の回数
                bcount = calcBCount(frequency, bmonth1, bmonth2);
                rest = Math.floor((payment - bcount * baddpay) / frequency / 100) * 100;
                bonus = rest + baddpay;
                
                // 初回がボーナス月であるかどうか
                const isFirstBonus = calcFDate() === bmonth1 || calcFDate() === bmonth2;
                if (isFirstBonus) {
                    first = payment - rest * (frequency - 1) - bcount * baddpay + baddpay;
                } else {
                    first = payment - rest * (frequency - 1) - bcount * baddpay;
                }
            }

            // 計算結果の表示
            displayEMPResults({
                price,
                dpay,
                frequency,
                advance,
                interestRate,
                interestAmount,
                payment,
                total,
                first,
                rest,
                bonus,
                bcount,
                bmonth1,
                bmonth2,
                baddpay,
                isValidFrequency
            });
        }

        function displayEMPResults(results) {
            const resultsDiv = document.getElementById('emp-results');
            resultsDiv.classList.remove('hidden');
            
            // 初回がボーナス月か
            const isFirstBonus = calcFDate() === results.bmonth1 || calcFDate() === results.bmonth2;
            
            // ボーナス払いがあるか
            const isBonus = results.bmonth1 !== 0 || results.bmonth2 !== 0;

            let html = `<h3>計算結果</h3>`;
            
            if (!results.isValidFrequency) {
                html += `
                <div class="warning">
                    <p>支払回数「${results.frequency}回」は当社で選択出来る支払回数と異なりますので、計算結果は参考数値としてご利用下さい。</p>
                </div>
                `;
            }

            html += `
            <div class="results-summary">
                <div>
                    <p class="font-semibold">商品価格</p>
                    <p class="text-lg">${formatNumber(results.price)}円</p>
                </div>
                <div>
                    <p class="font-semibold">頭金</p>
                    <p class="text-lg">${formatNumber(results.dpay)}円</p>
                </div>
                <div>
                    <p class="font-semibold">分割対象金額</p>
                    <p class="text-lg">${formatNumber(results.advance)}円</p>
                </div>
                <div>
                    <p class="font-semibold">支払回数</p>
                    <p class="text-lg">${results.frequency}回</p>
                </div>
                <div>
                    <p class="font-semibold" style="color: #ca0028;">手数料（金利）</p>
                    <p class="text-lg">${formatNumber(results.interestAmount)}円（${results.interestRate}%）</p>
                </div>
            </div>

            <div class="results-detail">
                <div class="detail-header">
                    <p class="font-bold">お支払い内訳</p>
                    <p class="text-sm">※金額単位：円</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th style="text-align: right;">金額</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${isFirstBonus ? "第1回目お支払い額（ボーナス月）" : "第1回目お支払い額"}</td>
                            <td class="amount">${formatNumber(results.first)}円</td>
                        </tr>
                        <tr>
                            <td>通常回のお支払い額（×${results.frequency - 1}回）</td>
                            <td class="amount">${formatNumber(results.rest)}円</td>
                        </tr>
            `;

            if (isBonus && results.baddpay > 0 && !(isFirstBonus && results.bcount === 1)) {
                html += `
                        <tr>
                            <td>${isFirstBonus ? 
                                `ボーナス回（初回除く${results.bcount - 1}回）のお支払い額` : 
                                `ボーナス回（${results.bcount}回）のお支払い額`}</td>
                            <td class="amount">${formatNumber(results.bonus)}円</td>
                        </tr>
                `;
            }

            html += `
                    </tbody>
                </table>
                
                <div class="total-amounts">
                    <div class="total-item">
                        <p>お支払い総額（頭金を含む）</p>
                        <p>${formatNumber(results.total)}円</p>
                    </div>
                    <div class="total-item">
                        <p>分割支払金合計（当社へのお支払い）</p>
                        <p>${results.payment > 1589600 ? 
                            `${formatNumber(results.payment)}円（当社ご契約条件外）` : 
                            `${formatNumber(results.payment)}円`}</p>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <h4 class="font-semibold mb-2">お支払い総額の内訳</h4>
                <div class="progress-bar">
                    <div class="progress-segment principal" style="width: ${(results.advance/results.total*100).toFixed(1)}%">
                        元金: ${(results.advance/results.total*100).toFixed(1)}%
                    </div>
                    <div class="progress-segment interest" style="width: ${(results.interestAmount/results.total*100).toFixed(1)}%">
                        手数料: ${(results.interestAmount/results.total*100).toFixed(1)}%
                    </div>
                    ${results.dpay > 0 ? `
                    <div class="progress-segment downpayment" style="width: ${(results.dpay/results.total*100).toFixed(1)}%">
                        頭金: ${(results.dpay/results.total*100).toFixed(1)}%
                    </div>
                    ` : ''}
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="color-box principal"></div>
                        <span>元金: ${formatNumber(results.advance)}円</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box interest"></div>
                        <span>手数料: ${formatNumber(results.interestAmount)}円</span>
                    </div>
                    ${results.dpay > 0 ? `
                    <div class="legend-item">
                        <div class="color-box downpayment"></div>
                        <span>頭金: ${formatNumber(results.dpay)}円</span>
                    </div>
                    ` : ''}
                </div>
            </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        function resetEMP() {
            document.getElementById('emp-results').classList.add('hidden');
        }

        // MPF（商品金額と希望金額から）の計算
        document.getElementById('calculate-mpf').addEventListener('click', calculateMPF);
        document.getElementById('reset-mpf').addEventListener('click', resetMPF);

        function calculateMPF() {
            // 入力値の取得
            const price = Number(document.getElementById('mpf-price').value);
            const dpay = Number(document.getElementById('mpf-dpay').value);
            const expect = Number(document.getElementById('mpf-expect').value);
            const bmonth1 = Number(document.getElementById('mpf-bmonth1').value);
            const bmonth2 = Number(document.getElementById('mpf-bmonth2').value);
            const baddpay = Number(document.getElementById('mpf-baddpay').value);

            // 残金(立替額)
            const advance = price - dpay;

            // 選択可能な支払回数
            let selectedFreq = 0;
            let flag1 = false;
            let flag2 = false;

            for (let i = 0; i < validFrequencies.length; i++) {
                const freq = validFrequencies[i];
                
                // 手数料率
                const interestRate = getRate(freq - 1);
                
                // 分割支払金合計
                const tmpPayment = advance + Math.floor(advance * interestRate * 100 / 10000);
                
                let tmpRest = 0;

                // 初回と通常回の分割支払金の算出
                if (bmonth1 === 0 && bmonth2 === 0) {
                    tmpRest = Math.floor(tmpPayment / freq / 100) * 100;
                } else if (baddpay === 0) {
                    tmpRest = Math.floor(tmpPayment / freq / 100) * 100;
                } else {
                    // ボーナス回の回数
                    const bcount = calcBCount(freq, bmonth1, bmonth2);
                    tmpRest = Math.floor((tmpPayment - bcount * baddpay) / freq / 100) * 100;
                }

                if (tmpRest === expect) {
                    flag1 = true;
                    flag2 = true;
                    selectedFreq = freq;
                    break;
                } else if (tmpRest > expect) {
                    flag1 = true;
                } else if (tmpRest < expect) {
                    flag2 = true;
                }
                
                if (flag1 && flag2) {
                    selectedFreq = freq;
                    break;
                }
            }

            if (!flag1) {
                selectedFreq = validFrequencies[0];
            } else if (!flag2) {
                selectedFreq = validFrequencies[validFrequencies.length - 1];
            }

            // 選択された回数で再計算
            const interestRate = getRate(selectedFreq - 1);
            const interestAmount = Math.floor(advance * interestRate * 100 / 10000);
            const payment = advance + interestAmount;
            const total = payment + dpay;

            let first, rest, bonus = 0;
            let bcount = 0;

            // 初回と通常回の分割支払金の算出
            if (bmonth1 === 0 && bmonth2 === 0) {
                rest = Math.floor(payment / selectedFreq / 100) * 100;
                first = payment - rest * (selectedFreq - 1);
            } else if (baddpay === 0) {
                rest = Math.floor(payment / selectedFreq / 100) * 100;
                first = payment - rest * (selectedFreq - 1);
            } else {
                // ボーナス回の回数
                bcount = calcBCount(selectedFreq, bmonth1, bmonth2);
                rest = Math.floor((payment - bcount * baddpay) / selectedFreq / 100) * 100;
                bonus = rest + baddpay;
                
                // 初回がボーナス月であるかどうか
                const isFirstBonus = calcFDate() === bmonth1 || calcFDate() === bmonth2;
                if (isFirstBonus) {
                    first = payment - rest * (selectedFreq - 1) - bcount * baddpay + baddpay;
                } else {
                    first = payment - rest * (selectedFreq - 1) - bcount * baddpay;
                }
            }

            // 計算結果の表示
            displayMPFResults({
                price,
                dpay,
                advance,
                expect,
                selectedFreq,
                interestRate,
                interestAmount,
                payment,
                total,
                first,
                rest,
                bonus,
                bcount,
                bmonth1,
                bmonth2,
                baddpay
            });
        }

        function displayMPFResults(results) {
            const resultsDiv = document.getElementById('mpf-results');
            resultsDiv.classList.remove('hidden');
            
            // 初回がボーナス月か
            const isFirstBonus = calcFDate() === results.bmonth1 || calcFDate() === results.bmonth2;
            
            // ボーナス払いがあるか
            const isBonus = results.bmonth1 !== 0 || results.bmonth2 !== 0;

            let html = `
            <h3>計算結果</h3>
            
            <p class="mb-4">
                当社で選択出来る支払回数のうち、ご希望のお支払い額に近くなるのは
                <span class="font-bold text-lg mx-1">${results.selectedFreq}回</span>
                になります。
            </p>

            <div class="results-summary">
                <div>
                    <p class="font-semibold">商品価格</p>
                    <p class="text-lg">${formatNumber(results.price)}円</p>
                </div>
                <div>
                    <p class="font-semibold">頭金</p>
                    <p class="text-lg">${formatNumber(results.dpay)}円</p>
                </div>
                <div>
                    <p class="font-semibold">分割対象金額</p>
                    <p class="text-lg">${formatNumber(results.advance)}円</p>
                </div>
                <div>
                    <p class="font-semibold">月々のご希望額</p>
                    <p class="text-lg">${formatNumber(results.expect)}円</p>
                </div>
                <div>
                    <p class="font-semibold" style="color: #ca0028;">手数料（金利）</p>
                    <p class="text-lg">${formatNumber(results.interestAmount)}円（${results.interestRate}%）</p>
                </div>
            </div>

            <div class="results-detail">
                <div class="detail-header">
                    <p class="font-bold">お支払い内訳</p>
                    <p class="text-sm">※金額単位：円</p>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>項目</th>
                            <th style="text-align: right;">金額</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${isFirstBonus ? "第1回目お支払い額（ボーナス月）" : "第1回目お支払い額"}</td>
                            <td class="amount">${formatNumber(results.first)}円</td>
                        </tr>
                        <tr>
                            <td>通常回のお支払い額（×${results.selectedFreq - 1}回）</td>
                            <td class="amount">${formatNumber(results.rest)}円</td>
                        </tr>
            `;

            if (isBonus && results.baddpay > 0 && !(isFirstBonus && results.bcount === 1)) {
                html += `
                        <tr>
                            <td>${isFirstBonus ? 
                                `ボーナス回（初回除く${results.bcount - 1}回）のお支払い額` : 
                                `ボーナス回（${results.bcount}回）のお支払い額`}</td>
                            <td class="amount">${formatNumber(results.bonus)}円</td>
                        </tr>
                `;
            }

            html += `
                    </tbody>
                </table>
                
                <div class="total-amounts">
                    <div class="total-item">
                        <p>お支払い総額（頭金を含む）</p>
                        <p>${formatNumber(results.total)}円</p>
                    </div>
                    <div class="total-item">
                        <p>分割支払金合計（当社へのお支払い）</p>
                        <p>${results.payment > 1589600 ? 
                            `${formatNumber(results.payment)}円（当社ご契約条件外）` : 
                            `${formatNumber(results.payment)}円`}</p>
                    </div>
                </div>
            </div>

            <div class="progress-container">
                <h4 class="font-semibold mb-2">お支払い総額の内訳</h4>
                <div class="progress-bar">
                    <div class="progress-segment principal" style="width: ${(results.advance/results.total*100).toFixed(1)}%">
                        元金: ${(results.advance/results.total*100).toFixed(1)}%
                    </div>
                    <div class="progress-segment interest" style="width: ${(results.interestAmount/results.total*100).toFixed(1)}%">
                        手数料: ${(results.interestAmount/results.total*100).toFixed(1)}%
                    </div>
                    ${results.dpay > 0 ? `
                    <div class="progress-segment downpayment" style="width: ${(results.dpay/results.total*100).toFixed(1)}%">
                        頭金: ${(results.dpay/results.total*100).toFixed(1)}%
                    </div>
                    ` : ''}
                </div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="color-box principal"></div>
                        <span>元金: ${formatNumber(results.advance)}円</span>
                    </div>
                    <div class="legend-item">
                        <div class="color-box interest"></div>
                        <span>手数料: ${formatNumber(results.interestAmount)}円</span>
                    </div>
                    ${results.dpay > 0 ? `
                    <div class="legend-item">
                        <div class="color-box downpayment"></div>
                        <span>頭金: ${formatNumber(results.dpay)}円</span>
                    </div>
                    ` : ''}
                </div>
            </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        function resetMPF() {
            document.getElementById('mpf-results').classList.add('hidden');
        }

        // 入力値の検証
        const inputFields = document.querySelectorAll('input[type="number"]');
        inputFields.forEach(input => {
            input.addEventListener('change', function() {
                // 値が空の場合は0を設定
                if (this.value === '') {
                    this.value = 0;
                }
                
                // 最小値と最大値のチェック
                if (this.hasAttribute('min') && Number(this.value) < Number(this.getAttribute('min'))) {
                    this.value = this.getAttribute('min');
                }
                if (this.hasAttribute('max') && Number(this.value) > Number(this.getAttribute('max'))) {
                    this.value = this.getAttribute('max');
                }
            });
        });
    </script>
</body>
</html>
